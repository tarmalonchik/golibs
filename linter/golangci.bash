#!/bin/bash

BASE_CONFIG=".golangci.base.yaml"
LOCAL_TEMPLATE="golangci-template.yaml"
FINAL_CONFIG=".golangci.yaml"

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è yq
if ! command -v yq &> /dev/null; then
    echo "–û—à–∏–±–∫–∞: yq –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ: https://github.com/mikefarah/yq"
    exit 1
fi

# 2. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞
echo "üì• –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞..."
curl -sSL "$REMOTE_CONFIG_URL" -o "$BASE_CONFIG"

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞"
    exit 1
fi

# 3. –ú–µ—Ä–∂ —Ñ–∞–π–ª–æ–≤
# –õ–æ–≥–∏–∫–∞ yq: –ø–µ—Ä–≤—ã–π —Ñ–∞–π–ª –≤ —Å–ø–∏—Å–∫–µ ‚Äî –±–∞–∑–∞, –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—Ç –µ–≥–æ.
# –û–ø–µ—Ä–∞—Ç–æ—Ä '*+' –¥–µ–ª–∞–µ—Ç –≥–ª—É–±–æ–∫–∏–π –º–µ—Ä–∂, –≤–∫–ª—é—á–∞—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–æ–≤ (–ª–∏–Ω—Ç–µ—Ä–æ–≤).
if [ -f "$LOCAL_TEMPLATE" ]; then
    echo "üîÑ –ú–µ—Ä–∂ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞ —Å –ª–æ–∫–∞–ª—å–Ω—ã–º —à–∞–±–ª–æ–Ω–æ–º (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ)..."
    yq eval-all 'select(fileIndex == 0) *+ select(fileIndex == 1)' "$BASE_CONFIG" "$LOCAL_TEMPLATE" > "$FINAL_CONFIG"
else
    echo "‚ö†Ô∏è –õ–æ–∫–∞–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω $LOCAL_TEMPLATE –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —É–¥–∞–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥."
    cp "$BASE_CONFIG" "$FINAL_CONFIG"
fi

# 4. –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
rm "$BASE_CONFIG"

echo "‚úÖ –§–∞–π–ª $FINAL_CONFIG —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!"